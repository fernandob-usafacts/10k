<!DOCTYPE HTML>
<html lang="en">
  <head>
     <meta charset="UTF-8">
     <title>10k report</title>
  </head>
  <body>

    <svg id="viz"></svg>

    <script src="d3.v7.min.js"></script>
    <script>
      function getUniquesMenu(df, thisVariable) {
          var thisList = df.map(function(o) {
              return o[thisVariable]
          })

          // uniq() found here https://stackoverflow.com/questions/9229645/remove-duplicate-values-from-js-array
          function uniq(a) {
              return a.sort().filter(function(item, pos, ary) {
                  return !pos || item != ary[pos - 1];
              });
          }

          var uniqueList = uniq(thisList);

          return uniqueList;
      }

      Promise.all([
        d3.csv("10k_indicators.csv")
      ]).then(function(data){

        const lineHeight = 16;

        let indicators = data[0];
        indicators.forEach(d => {
          d['2009'] = +d['2009'];
          d['2014'] = +d['2014'];
          d['2018'] = +d['2018'];
          d['2019'] = +d['2019'];
          d['Change 2019 vs 2009'] = +d['Change 2019 vs 2009'];
          d['Change 2019 vs 2014'] = +d['Change 2019 vs 2014'];
          d['Change 2019 vs 2018'] = +d['Change 2019 vs 2018'];
        });

        console.log(indicators);

        const changeCols = indicators.columns.filter(d => d.includes('Change'));
        const yearCols = ['2009', '2014', '2018', '2019'];
        const colWidth = 450;
        const positiveColor = '#4d9221',
          negativeColor = '#c51b7d';

        let getAllNames = (sourceData, field) => {
          let offset = 0;
          let names = [];

          getUniquesMenu(sourceData, field).forEach(d => {
            let number = sourceData.filter(f => f[field] == d).length;
            let obj = {
              "name": d,
              "number": number,
              "offset": offset
            };
            offset += number * lineHeight;
            names.push(obj);
          });

          return names;
        }

        const segments = getAllNames(indicators, 'segment');
        const categories = getAllNames(indicators, 'category');
        const subcategories = getAllNames(indicators, 'subcategory');

        const svg = d3.select("#viz")
          .attr("width", segments.length * colWidth)
          .attr("height", (indicators.length + 2) * lineHeight);

        const gSegment = svg.selectAll(".segment")
          .data(segments)
          .join("g")
            .attr("class", "segment")
            .attr("transform", (d,i) => `translate(${i * colWidth},0)`)
  
        gSegment.selectAll(".title")
          .data(d => [d])
          .join("text")
            .attr("class", "title")
            .attr("font-size", 16)
            .style("font-weight", 700)
            .attr("y", lineHeight)
            .text(d => d.name);

        const textIndicator = gSegment.selectAll(".indicator")
          .data(d => indicators.filter(ind => ind.segment === d.name))
          .join("text")
            .attr("class", "indicator")
            .attr("font-size", 12)
            .attr("y", (d,i) => (i + 2) * lineHeight)
            .text(d => d.indicator);

        const changes = gSegment.selectAll(".change")
          .data(d => indicators.filter(ind => ind.segment === d.name))
          .join("g")
            .attr("class", "change")
            .attr("transform", (d,i) => `translate(350,${(i + 1.25) * lineHeight})`)
          .selectAll(".square")
          .data(d => changeCols.map(col => {
            return {
              "value": d[col],
              "color": d.good_trend === 'negative' ? (d[col] < 0 ? positiveColor : negativeColor) : (d[col] > 0 ? positiveColor : negativeColor)
            }})
          )
          .join("rect")
            .attr("width", lineHeight)
            .attr("height", lineHeight)
            .attr("x", (d,i) => i * lineHeight)
            .attr("y", 0)
            .attr("fill", d => d.color)
            .style("stroke", "white")
            .style("stroke-width", 0.5)
        
      })
    </script>
  </body>
</html>